# 2025-04-05

## TODO

Write up on safe area view
Get audio playback working

Podcast page

- [ ] tap to start playing the episode

Media player

- [ ] Mini media player at the bottom
- [ ] Just play/pause

### Nice-to-haves

- [ ] The podcast sheet should fetch a subset of the show's information (we shouldn't fetch the whole XML - some podcasts like the Economist have like 50 MB RSS feed from 2015 and don't support Last-Modified headers)

I think the main idea is to add the podcast first, then populate the episodes in the background - perhaps a toast that drops down telling the user the episodes are being loaded.

Then the SQLite table should have a state variable for whether the episodes have been loaded or not.

- [ ] add error state for new podcast sheet

- [ ] Add episodes in batches

Or else we risk too many SQL variables error.
We can just test with a podcast with many episodes like Joe Rogan or Economist.

- [ ] special scroll bar similar to google photos for quickly jumping to different dates
_ [ ] research about safe area view and how to remove the notch section at the top.
- [ ] research into download types
- [ ] explore logging mechanism in expo
- [ ] Add vibrations (e.g. when scrubbing through the audio)
- [ ] how mp3s and audio files work

### Deleting podcasts

- [ ] Be able to quit the app / pause and resume the download later
- [ ] Be able to cancel the download
- [ ] Be able to delete downloaded items

### Bugs

Bugs to fix - very long load for large rss feed
crash when too many episodes
cannot delete the entered URL
never clear state when sheet is dismissed
podcasts should be shown in reverse order so the newest one is animated in

## Notes

### Refactor Data Fetching

We don't really need live queries, we can always refetch the data
again if needed (whenever we open the tab).

Instead, we can just wrap our data in a basic `useSQLiteQuery` hook
which allows us to get loading and error states.

I think this will make the loading of the podcast page a bit
more snappy.
We do need to implement pull to refresh though.

- [x] refactor to use sqlite query hook to avoid lag on first render

- [x] Delete podcast

Create a podcast actions sheet - for now there is only
the option to delete, with an alert dialog
warning you that you're about to delete the podcast.

The delete behaviour would be to remove the podcast,
episode, downloads and any of the downloaded
files from the database.

This clean up might take a while to do, so there should
be some kind of loading UI that indicates this.

Unfortunately I don't think we can handle rollback
operations for this, but we can try grouping all of the operations into a single drizzle transaction.
But first the files and the resumable download handldes need to be deleted first.

- [x] Fix re-renders on the podcast actions sheet

Bug fixes - updating the styling of the download card,
fixing the download update issue (forgot to `await` the `updateDownloadState` call)

### Audio Playback

Get audio playback working for the downloaded episodes.

### Development Builds

Reading about [Expo development builds](https://docs.expo.dev/develop/development-builds/introduction/)
which seems quite relevant for using `react-media-track-player` which has native code.

Details on [creating a build](https://docs.expo.dev/develop/development-builds/create-a-build/).

First build took about 5 mins.

After that I could run using `pnpm expo start --tunnel`.

### React Native Track Player Bug

There was a crash, but it was fixed by running `npx expo install react-native-svg`.

Getting some strange errors now after installing `react-native-track-player`.
Going to clean and rebuild the android project.

```bash
z android
./gradlew clean
z ..
npx expo run:android
```

Doesn't solve the issue, seems like this has been an open issue with React Native's new architecture
for the [last year](https://github.com/doublesymmetry/react-native-track-player/issues/2293).

The suggested solution was to disable the new architectur
which can be done in `app.json` by setting `newArchEnabled` to `false` for Expo
and in the `android/gradle.properties` file by setting `newArchEnabled=false`.

Doing both fixed the issue.
